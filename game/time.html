<!DOCTYPE html>
<html>
<head>
    <title>Time Game | HSNU 1481</title>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="https://www.w3schools.com/w3css/4/w3.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-firestore.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyAW060kfFPzaSKzflp9eXesmyn-GMYj-M8",
            authDomain: "hsnu-1481-website.firebaseapp.com",
            databaseURL: "https://hsnu-1481-website.firebaseio.com",
            projectId: "hsnu-1481-website",
            storageBucket: "hsnu-1481-website.appspot.com",
            messagingSenderId: "405025421965",
            appId: "1:405025421965:web:7b6d32809d1eb939"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
    </script>
    <script>
        var FF = new Event("FF");
        var newRecord = false;
        // Functions
        var gameCloudExist = false;
        var useCloud = false;
        var game = {
            best: parseInt(localStorage["timeGameRecord"]) || "-",
            total: parseInt(localStorage["timeGamePoints"]) || 0
        };
        firebase.auth().onAuthStateChanged(user => {
            if(user) {
                useCloud = true;
                getStatus();
                saveToLocal();
            }
        });
        
        function getStatus() {
            gameCloud("Time Game").get().then(doc=>{
                if(doc.exists) {
                    gameCloudExist = true;
                    game = doc.data();
                    gameCloud("Time Game").onSnapshot(function(doc) {
                        game = doc.data();
                        document.dispatchEvent(FF);
                    });
                }
            });
        }
        
        function upload() {
            if(gameCloudExist) {
                gameCloud("Time Game").update(game).then(()=>{
                    console.log("Game Data Uploaded.")
                }).catch(e=>console.error(e));
            } else {
                gameCloud("Time Game").set(game).then(()=>{
                    gameCloudExist = true;
                    console.log("Game Data Created.")
                }).catch(e=>console.error(e));
            }
        }
        
        function gameCloud(game) {
            return db.collection("Game").doc(game).collection("Data").doc(firebase.auth().currentUser.uid);
        }
        function addPoint(p=100) {
            game.total += p;
            saveToLocal();
        }
        
        function Record(r) {
            if(game.best == "-" || r < game.best) {
                game.best = r;
                newRecord = true;
                saveToLocal();
            }
        }
        function saveToLocal() {
            localStorage.timeGameRecord = game.best;
            localStorage.timeGamePoints = game.total;
        }
    </script>
    <style>
        .gameContainer {
            zoom: 1.2;
        }
        #timeGame {
            font-size: 6rem;
        }
        @media screen and (max-width: 600px){
            #timeGame {
                font-size: 5rem;
            }
        }
    </style>
</head>
<body>
    <div class="content">
        <!-- Navigation -->
        <div class="w3-bar w3-border-bottom">
            <a class="w3-bar-item w3-button" href="/"><span style="color: black !important; word-spacing: 1px;">HSNU</span> <b class="BlueGradient" style="color: royalblue;">1481</b></a> <a class="w3-bar-item w3-button w3-text-black" href="/news">新聞</a> <a class="w3-bar-item w3-button w3-text-black" href="/curriculum">課表</a> <a class="w3-bar-item w3-button w3-text-black" href="/forum">論壇</a> <a class="w3-bar-item w3-button w3-text-black" href="/product">產品</a> <a class="w3-bar-item w3-button w3-text-black w3-right" href="/me"><i class="fas fa-user-circle" style="font-size: 1.5rem;"></i></a>
        </div>
        <div class="w3-container w3-center gameContainer">
            <h2>Your Points: <span id="p"></span></h2>
            <h3>Best Record: <span id="r"></span></h3>
            <button class="w3-button w3-round w3-border w3-margin-bottom" id="timeGame">TIME</button><br>
            <button class="w3-button w3-round w3-border" id="button">Restart</button>
        </div>
    </div>
    <div class="footer w3-container w3-white">
        <span>Copyright © 2019 HSNU <b class="BlueGradient" style="color: royalblue;">1481</b>.<br>
            All rights reserved.</span>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8">
    </script>
    <script>
        var gamet = {
            "s_time": 0
        };
        var tg = document.getElementById("timeGame");
        var p = document.getElementById("p");
        var r = document.getElementById("r");
        document.addEventListener("FF", function(){
            console.log("Pushed To Board.");
            saveToLocal();
            p.innerHTML = game.total;
            r.innerHTML = game.best + " ms";
        });
        var button = document.getElementById("button");
        tg.onclick = function(){check()};
        button.onclick = function(){clearInterval(gamet.timer);start()};
        p.innerHTML = game.total;
        r.innerHTML = game.best + " ms";
        Swal.fire("Warning", "This game is very difficult.<br>Please don't be mad if you lose.", "warning").then(function(){start()});
        function start() {
            var g = gamet;
            var d = Date.now();
            var l = parseInt(1000 + Math.random()*4000);
            g.s_time = d + l;
            g.started = true;
            g.timer = setInterval(function() {
                let dd = gamet.s_time - Date.now();
                tg.innerHTML = (dd > 0) ? dd : -dd;
                tg.style.color = (dd > 0) ? "blue" : "orange";
            }, 2);
        }
        function check() {
            if(gamet.started == false)
                return;
            clearInterval(gamet.timer);
            gamet.started = false;
            var dd = 500 - parseInt(tg.innerHTML);
            Record(parseInt(tg.innerHTML));
            var gp = (dd > 0) ? parseInt(dd/5) : 0;
            addPoint(gp);
            if(useCloud) upload();
            p.innerHTML = game.total;
            Swal.fire("Finished", "You got " + gp + " point" + ((gp>1)?"s":""), ((dd > 0) ? "success" : "error")).then(function(){
                if(newRecord) {
                    Swal.fire("New Record!", "New Best Record: " + game.best + " ms", "success");
                    r.innerHTML = game.best + " ms";
                    newRecord = false;
                }
            });
        }
    </script>
</body>
</html>
